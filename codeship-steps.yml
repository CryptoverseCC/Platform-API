- type: serial
  # Available tag examples:
  # 0.1.0
  # 0.2.1-alpha
  # 1.3.2-alpha1
  # 1.5.3-alpha23
  # 1.8.0-beta
  # 2.13.0-beta2
  # 2.21.0-beta34
  # 2.34.6-rc1
  # 2.55.6-rc10
  # 2.89.6-rc23
  tag: '^\d+\.\d+\.\d+(-(alpha|beta|rc)\d*)?$'
  steps:

    - type: parallel
      steps:

        - service: base-python-image
          type: push
          image_name: userfeeds/base-python-image
          registry: https://index.docker.io/v1/
          encrypted_dockercfg_path: dockercfg.encrypted

    - type: parallel
      steps:

        - service: ranking-worker-simple
          type: push
          image_name: userfeeds/apps-ranking-runners-simple
          image_tag: '{{.Branch}}'
          registry: https://index.docker.io/v1/
          encrypted_dockercfg_path: dockercfg.encrypted

        - service: ranking-worker-queue
          type: push
          image_name: userfeeds/apps-ranking-queue
          image_tag: '{{.Branch}}'
          registry: https://index.docker.io/v1/
          encrypted_dockercfg_path: dockercfg.encrypted

        - service: ranking-server
          type: push
          image_name: userfeeds/apps-ranking-server
          image_tag: '{{.Branch}}'
          registry: https://index.docker.io/v1/
          encrypted_dockercfg_path: dockercfg.encrypted

- type: serial
  tag: '^\d+\.\d+\.\d+-api$'
  steps:

    - service: ranking-worker-simple
      type: push
      image_name: userfeeds/apps-ranking-runners-simple
      image_tag: '{{.Branch}}'
      registry: https://index.docker.io/v1/
      encrypted_dockercfg_path: dockercfg.encrypted

    - service: deploy
      image_name: userfeeds/deploy
      command: /app/deploy_api.sh rapsy
      encrypted_dockercfg_path: dockercfg.encrypted
      registry: https://index.docker.io/v1/
